# Copy and paste these commands directly into your server via SSH

# 1. SSH into server
ssh -p 24700 root@103.216.117.100

# 2. Update system and install Docker
sudo apt update
sudo apt install -y docker.io docker-compose
sudo systemctl start docker
sudo systemctl enable docker

# 3. Create application directory
sudo mkdir -p /var/www/engrisk-student-management
sudo chown -R root:root /var/www/engrisk-student-management
cd /var/www/engrisk-student-management

# 4. Clone repository
git clone https://github.com/haonnedu/engrisk-student-management.git .

# 5. Create Docker Compose file
cat > docker-compose.database.yml << 'EOF'
version: '3.8'
services:
  postgres:
    image: postgres:15
    container_name: engrisk-postgres
    environment:
      POSTGRES_DB: student_management
      POSTGRES_USER: engrisk_user
      POSTGRES_PASSWORD: EngRisk2024!SecureDB#789
    ports:
      - "5432:5432"
    volumes:
      - engrisk_postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  engrisk_postgres_data:
EOF

# 6. Start PostgreSQL container
sudo docker-compose -f docker-compose.database.yml up -d

# 7. Wait for database to be ready
echo "Waiting for database to be ready..."
for i in {1..30}; do
    if sudo docker exec engrisk-postgres pg_isready -U engrisk_user -d student_management >/dev/null 2>&1; then
        echo "✅ Database is ready!"
        break
    fi
    echo "Waiting for database... ($i/30)"
    sleep 10
done

# 8. Check container status
sudo docker ps -a | grep engrisk-postgres

# 9. Test database connection
sudo docker exec engrisk-postgres pg_isready -U engrisk_user -d student_management

echo "✅ Docker setup completed!"
echo "You can now run GitHub Actions deployment."
